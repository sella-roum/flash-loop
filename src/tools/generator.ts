import * as fs from 'node:fs/promises';
import * as path from 'node:path';

export class Generator {
  private filePath: string;

  constructor() {
    // ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆãƒ«ãƒ¼ãƒˆã« 'generated.spec.ts' ã¨ã„ã†åå‰ã§ä¿å­˜ã—ã¾ã™
    // å¿…è¦ã«å¿œã˜ã¦ã‚¿ã‚¤ãƒ ã‚¹ã‚¿ãƒ³ãƒ—ä»˜ãã®ãƒ•ã‚¡ã‚¤ãƒ«åãªã©ã«å¤‰æ›´ã—ã¦ãã ã•ã„
    this.filePath = path.join(process.cwd(), 'generated.spec.ts');
  }

  /**
   * ãƒ†ã‚¹ãƒˆãƒ•ã‚¡ã‚¤ãƒ«ã‚’åˆæœŸåŒ–ã—ã€ãƒ˜ãƒƒãƒ€ãƒ¼ï¼ˆimportæ–‡ãªã©ï¼‰ã‚’æ›¸ãè¾¼ã¿ã¾ã™
   */
  async init() {
    const header = `import { test, expect } from '@playwright/test';

test('FlashLoop Generated Test', async ({ page }) => {
  // Auto-generated by FlashLoop
  // Setup default timeout for AI interaction
  test.setTimeout(120000);
`;
    await fs.writeFile(this.filePath, header, 'utf-8');
    console.log(`ğŸ“„ Created test file: ${this.filePath}`);
  }

  /**
   * ç”Ÿæˆã•ã‚ŒãŸã‚³ãƒ¼ãƒ‰ã‚’ãƒ•ã‚¡ã‚¤ãƒ«ã«è¿½è¨˜ã—ã¾ã™
   */
  async appendCode(code: string) {
    // èª­ã¿ã‚„ã™ã•ã®ãŸã‚ã«ã‚¤ãƒ³ãƒ‡ãƒ³ãƒˆã‚’è¿½åŠ ã—ã¦æ›¸ãè¾¼ã¿ã¾ã™
    const indentedCode = code
      .split('\n')
      .map((line) => `  ${line}`)
      .join('\n');
    await fs.appendFile(this.filePath, `${indentedCode}\n`, 'utf-8');
  }

  /**
   * ãƒ†ã‚¹ãƒˆãƒ–ãƒ­ãƒƒã‚¯ã®é–‰ã˜æ‹¬å¼§ã‚’æ›¸ãè¾¼ã‚“ã§ãƒ•ã‚¡ã‚¤ãƒ«ã‚’å®Œæˆã•ã›ã¾ã™
   */
  async finish() {
    await fs.appendFile(this.filePath, '});\n', 'utf-8');
  }

  getFilePath() {
    return this.filePath;
  }
}
